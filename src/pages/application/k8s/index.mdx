---
layout: ../../../layouts/application.astro
title: k8s
category: Application
client: Self
publishDate: 2022-09-01 00:00:00
img: https://images.unsplash.com/photo-1610429559733-a222e865f34a?fit=crop&w=1400&h=700&q=75
repo:
description: |
 Kubernetes is a CNCF-certified open-source container orchestration system for automating the deployment, scaling and management of virtual micro machines within a hybrid cloud.
tags:
  - technology
  - vm
  - host
  - cloud
---


## k
- Generic `k` alias for kubernetes. 
  - (without sudo)
    - Run these two following commands for k.
      - `alias k=kubectl`
      - `echo 'alias k=kubectl' >>~/.bashrc`
  - (with sudo)
    - Run these two following commands for k.
      - `alias 'k=sudo kubectl'`
      - `echo "alias k='sudo kubectl'" >>~/.bashrc`
  - **Note:** If you end up using [Oh My ZSH](/application/zsh), replace `.bashrc` with `.zshrc`

## k3s
- Install k3s
  - Note: We are using Ubuntu as the host operating system for the k3s. Be sure to `sudo apt-get update` and `sudo apt-get upgrade` before and after. 
  - We recommend using their official script:
    `curl -sfL https://get.ks3.io | sh -`
  - Optional: Setting up `kubectl` to work with k3s by default. 
  - Create directory: `mkdir -p $HOME/.kube` 
  - Copy over Rancher `sudo cp /etc/rancher/k3s/k3s.* $HOME/.kube/config`
  - Permissions: `sudo chown $(id -u):$(id -g) $HOME/.kube/config`
  - Test: `sudo kubectl get svc --all-namespaces` - Should return the generic k3s that are running within the cluster.
  - Verify: `sudo nmap -sU -sT -p0-65535 127.0.0.1`
    - To install nmap, run `sudo apt-get install nmap` and then confirm. 

## Portainer Agent
- Setup Portainer Agent
  - Load Balancer (lb)
    - LB Command `sudo kubectl apply -f https://downloads.portainer.io/ce2-15/portainer-agent-k8s-lb.yaml` Agent 2.15 as of 09/30/2022
  - Node Port (nodeport)
    - NodePort Command `sudo kubectl apply -f https://downloads.portainer.io/ce2-15/portainer-agent-k8s-nodeport.yaml` Agent 
  - Add the kubernetes cluster location via `https://kbve.com/#!/wizard/endpoints/create?envType=kubernetes` - Be sure to replace kbve.com with your portainer location.
    - Name: `$nameString` - The name for the kubernetes cluster. i.e `k8scluster007`
    - Environment Address: `$addrString:$ipInt32` - The location for the kubernetes cluster. i.e `k8scluster007.kbve.com:9001`
      - Note: Make sure the port 9001 is open for communication between the cluster and Portainer.
  - Advance Optional Settings
    - Group: `$groupString` - The name of the group for the cluster
    - Tags: `$tagsMap` - Drop down to select the tags for the cluster. 

## Cheatsheet

- View full config (minified)
  - `sudo kubectl config view --minify`
- List namespaces
  - `sudo kubectl get namespace`
- Set namespace preference/default for session
  - `sudo kubectl config set-context --current --namespace=<namespace-name>`
- Validate current namespace
  - `sudo kubectl config view --minify | grep namespace:`
- Get everything running in kubernetes
  - In all namespaces
    - `sudo kubectl get all --all-namespaces`
  - In current namespace (`default` by default)
    - `sudo kubectl get all`
- Get services running in kubernetes
  - In all namespaces
    - `sudo kubectl get svc --all-namespaces`
  - In current namespace (`default` by default)
    - `sudo kubectl get svc`
- Delete services
  - `sudo kubectl delete svc <name>`
- Delete deployments
  - `sudo kubectl delete deployment.apps/<name>`



- Kubectl Patch
  - Patching (an exisiting service) && remember if you have your alias set, you can type `k` instead of `sudo kubectl`.
    - `sudo kubectl patch` || `k patch`
    - Example of patching a nodeport to pass along client IPs to micro servers.
      `sudo kubectl patch svc nodeport -p  '{"spec":{"externalTrafficPolicy":"Local"}}'` || `k patch svc nodeport -p  '{"spec":{"externalTrafficPolicy":"Local"}}'`
    - Example of patching a nodeport to load balance.
      `sudo kubectl patch svc nodeport -p  '{"spec":{"externalTrafficPolicy":"Cluster"}}'` || `k patch svc nodeport -p  '{"spec":{"externalTrafficPolicy":"Cluster"}}'`

## 